VERSION 0.6
FROM ../../../+rios-ai

# Custom dependencies needed for this specific React Web UI
custom-dependencies:
    FROM +base
    
    WORKDIR /opt/rios/src

    # Install Node.js and npm for React build
    RUN apt-get update && apt-get install -y \
        nodejs \
        npm \
        && rm -rf /var/lib/apt/lists/*
    
    # Copy package files for React app
    COPY ../../package*.json ./
    
    # Install React dependencies
    RUN npm ci --only=production
    
    # Copy React source code and config files
    COPY ../../src ./src
    COPY ../../public ./public
    COPY ../../tailwind.config.js ./
    COPY ../../tsconfig.json ./
    COPY ../../postcss.config.js ./
    
    # Build the React app
    RUN npm run build

# Install nginx for serving static files
dep-setup:
    FROM +custom-dependencies
    
    # Install nginx
    RUN apt-get update && apt-get install -y nginx && rm -rf /var/lib/apt/lists/*
    
    # Copy built React app to nginx directory
    COPY --from=+custom-dependencies /opt/rios/src/build /var/www/html
    
    # Configure nginx for React SPA
    RUN echo 'server { listen 80; root /var/www/html; index index.html; location / { try_files $uri $uri/ /index.html; } }' > /etc/nginx/sites-available/default

ros-setup:
    FROM +dep-setup
    EXPOSE 80
    CMD ["nginx", "-g", "daemon off;"]

tag-image: # Use the shared Tag Image code
    FROM +ros-setup

    ARG CURRENT_REPO
    ARG CURRENT_BRANCH
    ARG CURRENT_COMMIT_HASH
    ARG CURRENT_TAG=latest
    ARG VERSION=0.1
    ARG CURRENT_DATETIME

    LABEL buildtime=$CURRENT_DATETIME

    DO ../../../+TAG_IMAGE --BRANCH=$VERSION --REPO=rios-ai --COMMIT=$CURRENT_COMMIT_HASH
